#!/usr/bin/expect -f

# è“ç‰™è‡ªåŠ¨é…å¯¹è„šæœ¬
# è‡ªåŠ¨å¤„ç†å¯†é’¥ç¡®è®¤

set timeout 300

puts "======================================"
puts "ğŸ”‘ è“ç‰™è‡ªåŠ¨é…å¯¹è„šæœ¬"
puts "======================================"
puts ""
puts "ğŸ“± è¯·åœ¨å®‰å“è®¾å¤‡ä¸Šæœç´¢å¹¶å°è¯•é…å¯¹"
puts "ğŸ”„ è„šæœ¬å°†è‡ªåŠ¨ç¡®è®¤é…å¯¹å¯†é’¥"
puts ""

# å¯åŠ¨bluetoothctl
spawn sudo bluetoothctl

# ç­‰å¾…bluetoothctlå¯åŠ¨
expect "bluetooth*"

# å‘é€é…ç½®å‘½ä»¤
send "agent on\r"
expect "Agent registered"

send "default-agent\r"
expect "Default agent request successful"

send "pairable on\r"
expect "Changing pairable on succeeded"

send "discoverable on\r"
expect "Changing discoverable on succeeded"

puts "âœ… è“ç‰™å·²è®¾ç½®ä¸ºé…å¯¹æ¨¡å¼"
puts "ğŸ“± ç°åœ¨å¯ä»¥åœ¨æ‰‹æœºä¸Šå°è¯•é…å¯¹"

# ä¸»å¾ªç¯ - å¤„ç†é…å¯¹è¯·æ±‚
while {1} {
    expect {
        "Request PIN code*" {
            puts "ğŸ”‘ æ”¶åˆ°PINç è¯·æ±‚"
            send "0000\r"
            puts "ğŸ“¤ å·²å‘é€PINç : 0000"
        }
        
        "Confirm passkey*" {
            puts "ğŸ”‘ æ”¶åˆ°å¯†é’¥ç¡®è®¤è¯·æ±‚"
            puts "ğŸ“± è¯·æ£€æŸ¥æ‰‹æœºä¸Šæ˜¾ç¤ºçš„å¯†é’¥æ˜¯å¦ä¸€è‡´"
            send "yes\r"
            puts "âœ… å·²ç¡®è®¤å¯†é’¥"
        }
        
        "*agent*Confirm passkey*" {
            puts "ğŸ”‘ ä»£ç†å¯†é’¥ç¡®è®¤è¯·æ±‚"
            puts "ğŸ“± è¯·æ£€æŸ¥æ‰‹æœºä¸Šæ˜¾ç¤ºçš„å¯†é’¥æ˜¯å¦ä¸€è‡´"
            send "yes\r"
            puts "âœ… å·²ç¡®è®¤å¯†é’¥"
        }
        
        "Request confirmation*" {
            puts "ğŸ”‘ æ”¶åˆ°é…å¯¹ç¡®è®¤è¯·æ±‚"
            send "yes\r"
            puts "âœ… å·²ç¡®è®¤é…å¯¹"
        }
        
        "Authorize service*" {
            puts "ğŸ” æ”¶åˆ°æœåŠ¡æˆæƒè¯·æ±‚"
            send "yes\r"
            puts "âœ… å·²æˆæƒæœåŠ¡"
        }
        
        "Pairing successful*" {
            puts "ğŸ‰ é…å¯¹æˆåŠŸï¼"
        }
        
        "Failed to pair*" {
            puts "âŒ é…å¯¹å¤±è´¥"
        }
        
        "Request canceled*" {
            puts "âš ï¸  é…å¯¹è¯·æ±‚è¢«å–æ¶ˆ"
        }
        
        "*NEW*Device*" {
            puts "ğŸ“± å‘ç°æ–°è®¾å¤‡"
        }
        
        "*CHG*Device*Connected: yes*" {
            puts "ğŸ”— è®¾å¤‡å·²è¿æ¥"
        }
        
        "*CHG*Device*Connected: no*" {
            puts "ğŸ”Œ è®¾å¤‡å·²æ–­å¼€"
        }
        
        timeout {
            puts "â° ç­‰å¾…é…å¯¹è¯·æ±‚ä¸­..."
            # ç»§ç»­ç­‰å¾…
        }
        
        eof {
            puts "ğŸ’¥ bluetoothctlæ„å¤–é€€å‡º"
            break
        }
    }
}

puts ""
puts "ğŸ”š é…å¯¹è„šæœ¬ç»“æŸ"
